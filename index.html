<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Render mxGraph XML (CDN fallback)</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #graphContainer {
        width: 100%;
        height: 100vh;
        border: 1px solid #ccc;
      }
      #error {
        position: absolute;
        top: 8px;
        left: 8px;
        background: #fee;
        padding: 8px;
        border: 1px solid #f99;
        display: none;
      }
    </style>
    <!-- Load viewer (registers shapes/stencils) if available locally, otherwise fallback to CDN viewer -->
    <script>
      (function loadViewerThenMx() {
        var localViewer = "/frontend/public/viewer.min.js";
        var remoteViewer = "https://viewer.diagrams.net/js/viewer.min.js";
        var mxPrimary =
          "https://cdn.jsdelivr.net/npm/@arvacims/mxgraph@3.9.8/javascript/mxClient.min.js";
        var mxSecondary = "https://unpkg.com/mxgraph@4.2.1/mxClient.min.js";

        function insertScript(src, cb) {
          var s = document.createElement("script");
          s.src = src;
          s.async = false;
          s.onload = function () {
            console.log("Loaded", src);
            if (cb) cb(null, src);
          };
          s.onerror = function () {
            console.warn("Failed to load", src);
            if (cb) cb(new Error("failed"));
          };
          document.head.appendChild(s);
        }

        // Try local viewer first
        insertScript(localViewer, function (err) {
          if (err) {
            // fallback to remote viewer
            insertScript(remoteViewer, function () {
              // After viewer is loaded, load mxClient
              insertScript(mxPrimary, function (mxErr) {
                if (mxErr) insertScript(mxSecondary);
              });
            });
          } else {
            // local viewer loaded (it likely set window.mxBasePath etc.)
            insertScript(mxPrimary, function (mxErr) {
              if (mxErr) insertScript(mxSecondary);
            });
          }
        });
      })();
    </script>
  </head>
  <body>
    <div id="error"></div>
    <div id="graphContainer"></div>

    <script>
      // Replace this string with the XML (escaped) you provided.
      var xml = `<mxGraphModel dx="786" dy="585" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="583" pageHeight="413" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="SGhFhDsp4yGYNef1wRKp-1" value="&lt;b&gt;&lt;font style=&quot;font-size: 29px;&quot;&gt;Welcome To FlowAnalytics&lt;/font&gt;&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="110" y="140" width="410" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SGhFhDsp4yGYNef1wRKp-2" value="Powered By Melvok.cok" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="147" y="177" width="290" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2" value="Actor" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;outlineConnect=0;" vertex="1" parent="1">
          <mxGeometry x="280" y="280" width="30" height="60" as="geometry" />
        </mxCell>
        <mxCell id="3" value="" style="shape=trapezoid;perimeter=trapezoidPerimeter;whiteSpace=wrap;html=1;fixedSize=1;" vertex="1" parent="1">
          <mxGeometry x="120" y="200" width="120" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  `;

      // Wait until library is available
      function whenMxReady(cb) {
        if (typeof mxClient !== "undefined") return cb();
        var i = 0;
        var t = setInterval(function () {
          i++;
          if (typeof mxClient !== "undefined") {
            clearInterval(t);
            cb();
          }
          if (i > 40) {
            clearInterval(t);
            document.getElementById("error").style.display = "block";
            document.getElementById("error").textContent =
              "mxClient did not load.";
          }
        }, 100);
      }

      whenMxReady(function () {
        if (!mxClient.isBrowserSupported()) {
          mxUtils.error("Browser not supported!", 200, false);
          return;
        }

        var container = document.getElementById("graphContainer");
        mxEvent.disableContextMenu(container);

        try {
          // parse the outer XML
          var doc = mxUtils.parseXml(xml);

          // If the root is <mxfile> with nested <diagram> nodes, extract the first
          var root = doc.documentElement;
          var modelNode = null;

          if (root && root.nodeName === "mxfile") {
            var diag = root.getElementsByTagName("diagram")[0];
            if (!diag)
              throw new Error("No <diagram> node found inside <mxfile>");

            // If the <diagram> element directly contains an <mxGraphModel> element
            // as a child (common when the XML isn't stored as text), prefer that.
            var firstElementChild = null;
            for (var i = 0; i < diag.childNodes.length; i++) {
              var node = diag.childNodes[i];
              if (node.nodeType === 1) {
                firstElementChild = node;
                break;
              }
            }

            if (
              firstElementChild &&
              firstElementChild.nodeName === "mxGraphModel"
            ) {
              modelNode = firstElementChild;
            } else {
              // The diagram element may contain text that is itself XML. Try to parse it.
              var text = mxUtils.getTextContent(diag) || "";

              // Some diagrams are stored as compressed/base64. Detect simple XML fallback first.
              if (text.trim().charAt(0) === "<") {
                var innerDoc = mxUtils.parseXml("<root>" + text + "</root>");
                modelNode = innerDoc.documentElement.firstChild;
              } else {
                // If not plain XML, try to decode possible HTML-escaped XML
                try {
                  var unescaped = text
                    .replace(/&lt;/g, "<")
                    .replace(/&gt;/g, ">")
                    .replace(/&amp;/g, "&");
                  var innerDoc2 = mxUtils.parseXml(
                    "<root>" + unescaped + "</root>"
                  );
                  modelNode = innerDoc2.documentElement.firstChild;
                } catch (err) {
                  // Log detailed info for debugging
                  console.error("Diagram rendering error:", err);

                  var eDiv = document.getElementById("error");
                  eDiv.style.display = "block";
                  eDiv.textContent =
                    "Error rendering diagram: " +
                    err.message +
                    "\nA fallback sample graph will be rendered for debug.";

                  // Fallback: render a simple sample graph to verify mxGraph and container are working
                  try {
                    container.innerHTML = "";
                    var demoGraph = new mxGraph(container);
                    demoGraph.setEnabled(false);
                    var parent = demoGraph.getDefaultParent();
                    demoGraph.getModel().beginUpdate();
                    try {
                      var v1 = demoGraph.insertVertex(
                        parent,
                        null,
                        "Sample A",
                        40,
                        40,
                        120,
                        40
                      );
                      var v2 = demoGraph.insertVertex(
                        parent,
                        null,
                        "Sample B",
                        260,
                        180,
                        120,
                        40
                      );
                      var e = demoGraph.insertEdge(parent, null, "", v1, v2);
                    } finally {
                      demoGraph.getModel().endUpdate();
                    }
                    // Try to fit/view
                    try {
                      demoGraph.view.refresh();
                      demoGraph.fit();
                    } catch (ee) {
                      /* ignore */
                    }
                    console.info("Rendered fallback demo graph");
                  } catch (demoErr) {
                    console.error("Fallback demo render failed:", demoErr);
                    eDiv.textContent +=
                      "\nFallback render failed: " + demoErr.message;
                  }
                }
              }
            }
          } else if (root && root.nodeName === "mxGraphModel") {
            modelNode = root;
          } else {
            // If user provided raw model XML
            modelNode =
              root.getElementsByTagName("mxGraphModel")[0] || root.firstChild;
          }

          if (!modelNode)
            throw new Error("Could not find a valid model node to decode");

          // Clear container and create graph
          container.innerHTML = "";
          // Ensure mxClient basePath/resource paths point to CDN so built-in shapes/stencils can be resolved
          try {
            if (
              mxClient &&
              (!mxClient.basePath ||
                mxClient.basePath.indexOf("arvacims") === -1)
            ) {
              mxClient.basePath =
                "https://cdn.jsdelivr.net/npm/@arvacims/mxgraph@3.9.8/javascript";
              mxClient.imageBasePath = mxClient.basePath + "/images";
              mxClient.resourceBase = mxClient.basePath + "/resources";
              console.log("mxClient.basePath set to", mxClient.basePath);
            }
          } catch (bpErr) {
            console.warn("Could not set mxClient.basePath:", bpErr);
          }

          var graph = new mxGraph(container);
          graph.setEnabled(false); // read-only

          // Decode model into graph
          var codec = new mxCodec(modelNode.ownerDocument);
          codec.decode(modelNode, graph.getModel());

          // Diagnostic: log first few cells and their styles to help debug shape rendering
          try {
            var model = graph.getModel();
            var cells = model.cells || model.getCells ? model.getCells() : null;
            console.log(
              "Model root cells:",
              cells && Object.keys(cells).slice(0, 10)
            );
          } catch (logErr) {
            // ignore
          }

          // Layout/refresh: zoom to fit content if available
          try {
            graph.view.refresh();
            graph.fit();
          } catch (fitErr) {
            console.warn("fit() failed:", fitErr.message);
          }
        } catch (err) {
          console.error(err);
          var eDiv = document.getElementById("error");
          eDiv.style.display = "block";
          eDiv.textContent = "Error rendering diagram: " + err.message;
        }
      });
    </script>
  </body>
</html>
